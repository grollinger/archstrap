#!/bin/bash
# shellcheck disable=SC2015,SC2016
# SC2015: Note that A && B || C is not if-then-else |#| however and/or statement works as expected
# SC2816: Expressions don't expand in single quotes, use double quotes for that | mirrors accept vars

set -eEuo pipefail
. helpers.sh

(( ${EUID-} ))&&_err 'Must be executed as superuser'
(( $# ))|| _err 'A mount point must be specified to bootstrap Arch Linux (e.g. /tmp)'
[[ -d "$1" ]]|| _err 'Mount point does not exist'

mnt="$1"; shift; packages=("$@")
rootFS='root.x86_64' chRoot='chroot.sh'
tarBall='archlinux-bootstrap-x86_64.tar.gz' tarSig="$tarBall.sig"
officialURL='https://archlinux.org'
globalMirror='https://geo.mirror.pkgbuild.com'

[[ -d "$mnt/$rootFS" ]]&&{ "$mnt/$rootFS"/bin/arch-chroot "$mnt/$rootFS"; exit; }

_warn 'Downloading bootstrap tarball & signature..'
for _ in "$globalMirror/iso/latest/$tarBall" "$officialURL/iso/latest/$tarSig"; do
  curl "$_" > "$mnt/${_##*/}"
done

_warn 'Target downloaded. Verifying tarball GPG signature..'
gpg --verify "$mnt/$tarSig" "$mnt/$tarBall"&& _msg 'Signature Verified'||
  _err 'Bad signature. Keys may need to be manually recieved'

tar -xzf "$mnt/$tarBall" -C "$mnt" --numeric-owner; rm "$mnt/$tarball" "$mnt/$tarSig"
_msg "Bootstrap tarball unpacked to $mnt/$rootFS"

mkdir "$mnt/$rootFS"/run/shm
[[ -d /usr/share/terminfo ]]&& cp -r /usr/share/terminfo "$mnt/$rootFS"/usr/share/
cp "$chRoot" 'helpers.sh' "$mnt/$rootFS"/; cp bash.bashrc "$mnt/$rootFS"/etc/
printf 'Server = %s/$repo/os/$arch\n' "$globalMirror" >>"$mnt/$rootFS"/etc/pacman.d/mirrorlist
_msg 'Created necessary chroot system files'

"$mnt/$rootFS"/bin/arch-chroot "$mnt/$rootFS" bash "$chRoot" "$mnt" "${packages[@]}"
