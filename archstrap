#!/bin/bash
# shellcheck disable=SC2016
# SC2816: Expressions don't expand in single quotes, use double quotes for that | It's intentional

set -eEuo pipefail
. helpers.sh

(( ${EUID-} ))&&_err 'Must be executed as superuser'
(( $# ))|| _err 'A mount point must be specified to bootstrap Arch Linux (e.g. /tmp)'
[[ -d "$1" ]]|| _err 'Mount point does not exist'

mnt="$1"; shift
rootFS='root.x86_64' chRoot='chroot.sh' packages=("$@")
tarBall='archlinux-bootstrap-x86_64.tar.gz' tarSig="$tarBall.sig"
officialURL='https://archlinux.org' globalMirror='https://geo.mirror.pkgbuild.com'

[[ -d "$mnt/$rootFS" ]]&&{ "$mnt/$rootFS"/bin/arch-chroot "$mnt/$rootFS"; exit; }

_warn 'Downloading bootstrap signature & tarball..'
_curl "$globalMirror/iso/latest/$tarBall" "$officialURL/iso/latest/$tarSig"

_warn 'Verifying tarball GPG signature..'
if gpg --verify "$mnt/$tarSig" "$mnt/$tarBall"; then _msg 'Signature Verified'
else _err 'Bad signature. Keys may need to be manually recieved'; fi

_untar "$mnt/$tarBall" "$mnt/$tarSig"

printf 'Server = %s/$repo/os/$arch\n' "$globalMirror" >>"$mnt/$rootFS"/etc/pacman.d/mirrorlist

mkdir "$mnt/$rootFS"/run/shm
[[ -d /usr/share/terminfo ]]&& cp -r /usr/share/terminfo "$mnt/$rootFS"/usr/share/

cp "$chRoot" 'helpers.sh' "$mnt/$rootFS"/
cp bash.bashrc "$mnt/$rootFS"/etc/

_msg 'Created necessary chroot system files'

mount --bind "$mnt/$rootFS" "$mnt/$rootFS"
"$mnt/$rootFS"/bin/arch-chroot "$mnt/$rootFS" bash "$chRoot" "$mnt" "${packages[@]}"
